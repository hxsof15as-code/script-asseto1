local sim = ac.getSim()
local selectedCar = nil ---@type ac.StateCar
local selectedCarIndex = nil
local teleportMode = 1
local disabledCollision = false
local teleportTimer = 0
local collisionDuration = 10
local isCollisionDisabled = false
local collisionDisabledTime = 0

local bannerImage = nil
local imageLoading = false
local imageLoaded = false
local imageWidth = 450
local imageHeight = 180
local imageUrl = 'https://g.top4top.io/p_367151kwf1.png'

if not imageLoading and not imageLoaded then
  imageLoading = true
  web.get(imageUrl, function(err, response)
    if err or not response or response.status ~= 200 then
      ac.log('[Teleport] فشل تحميل الصورة')
      imageLoading = false
    else
      local success, img = pcall(function()
        return ui.decodeImage(response.body)
      end)
      if success and img then
        bannerImage = img
        imageLoaded = true
        ac.log('[Teleport] تم تحميل الصورة بنجاح!')
      end
      imageLoading = false
    end
  end)
end

local function TeleportHUD()
  -- إجبار عرض النافذة
  local windowWidth = 500
  ui.pushItemWidth(windowWidth)
  
  if bannerImage then
    ui.setCursorX((windowWidth - imageWidth) / 2)
    ui.image(bannerImage, vec2(imageWidth, imageHeight))
    ui.offsetCursorY(15)
  end
  
  ui.pushDWriteFont('Arial;Weight=Bold')
  ui.beginOutline()
  local titleText = "نظام الانتقال إلى اللاعبين"
  local titleSize = ui.measureDWriteText(titleText, 24)
  ui.dwriteDrawText(titleText, 24, vec2((windowWidth - titleSize.x) / 2, ui.getCursorY()), rgbm(1, 1, 1, 1))
  ui.endOutline(rgbm(0, 0, 0, 1), 0.8)
  ui.popDWriteFont()
  
  ui.offsetCursorY(35)
  ui.separator()
  ui.offsetCursorY(25)
  
  ui.pushDWriteFont('Arial;Weight=Bold')
  ui.dwriteDrawText('اختر السيارة للانتقال إليها:', 16, vec2(30, ui.getCursorY()), rgbm(0.9, 0.9, 0.9, 1))
  ui.popDWriteFont()
  ui.offsetCursorY(30)
  
  local players = {}
  for i = 1, sim.carsCount - 1 do
    local car = ac.getCar(i)
    local driverName = ac.getDriverName(i)
    if car.isConnected and not car.isAIControlled and not string.find(driverName, "Traaaffic") then
      table.insert(players, {index = i, name = driverName, car = car})
    end
  end
  
  ui.pushDWriteFont('Arial;Weight=Bold')
  ui.pushStyleVar(ui.StyleVar.ItemSpacing, vec2(0, 0))
  
  if #players == 0 then
    ui.dwriteDrawText('لم يتم اختيار لاعب', 14, vec2(35, ui.getCursorY()), rgbm(0.7, 0.4, 0.3, 1))
    ui.offsetCursorY(20)
  else
    for idx, player in ipairs(players) do
      local isSelected = selectedCarIndex == player.index
      local cursorY = ui.getCursorY()
      
      local rowWidth = windowWidth - 60
      
      if isSelected then
        ui.drawRectFilled(
          vec2(30, cursorY), 
          vec2(rowWidth + 30, cursorY + 18), 
          rgbm(0.15, 0.45, 0.75, 0.5), 
          2
        )
      end
      
      local textColor = isSelected and rgbm(0.2, 0.7, 1, 1) or rgbm(0.95, 0.95, 0.95, 1)
      ui.dwriteDrawText(player.name, 14, vec2(40, cursorY + 1), textColor)
      
      ui.setCursor(vec2(30, cursorY))
      ui.dummy(vec2(rowWidth, 18))
      
      if ui.itemHovered() then
        ui.drawRect(
          vec2(30, cursorY), 
          vec2(rowWidth + 30, cursorY + 18), 
          rgbm(0.4, 0.4, 0.4, 0.6), 
          2, 
          1.2
        )
      end
      
      if ui.itemClicked() then
        selectedCar = player.car
        selectedCarIndex = player.index
      end
    end
  end
  
  ui.popStyleVar()
  ui.popDWriteFont()
  
  ui.offsetCursorY(25)
  ui.separator()
  ui.offsetCursorY(25)
  
  ui.pushDWriteFont('Arial')
  if not selectedCar then
    ui.dwriteDrawText('لم يتم اختيار لاعب', 15, vec2(35, ui.getCursorY()), rgbm(0.7, 0.4, 0.3, 1))
    ui.offsetCursorY(32)
  else
    local playerName = ac.getDriverName(selectedCarIndex)
    local speed = selectedCar.speedKmh
    local speedColor = rgbm(0.4, 0.9, 0.4, 1)
    if speed > 200 then
      speedColor = rgbm(1, 0.3, 0.3, 1)
    elseif speed > 100 then
      speedColor = rgbm(1, 0.7, 0.3, 1)
    end
    
    ui.dwriteDrawText('اللاعب المختار: ' .. playerName, 15, vec2(35, ui.getCursorY()), rgbm(0.3, 0.9, 0.3, 1))
    ui.offsetCursorY(28)
    ui.dwriteDrawText(string.format('السرعة: %d كم/س', math.floor(speed)), 15, vec2(35, ui.getCursorY()), speedColor)
    ui.offsetCursorY(32)
  end
  ui.popDWriteFont()
  
  if isCollisionDisabled then
    local timeLeft = math.max(0, 10 - (os.clock() - collisionDisabledTime))
    if timeLeft > 0 then
      ui.pushDWriteFont('Arial')
      ui.dwriteDrawText(string.format('التصادم معطل لمدة %d ثانية', math.ceil(timeLeft)), 14, vec2(35, ui.getCursorY()), rgbm(1, 0.85, 0.3, 1))
      ui.popDWriteFont()
      ui.offsetCursorY(28)
    else
      isCollisionDisabled = false
    end
  end
  
  ui.separator()
  ui.offsetCursorY(25)
  
  ui.pushDWriteFont('Arial;Weight=Bold')
  ui.dwriteDrawText('اختر وضع الانتقال:', 15, vec2(20, ui.getCursorY()), rgbm(0.9, 0.9, 0.9, 1))
  ui.popDWriteFont()
  ui.offsetCursorY(22)
  
  ui.pushStyleColor(ui.StyleColor.CheckMark, rgbm(0.2, 0.7, 1, 1))
  ui.pushStyleColor(ui.StyleColor.FrameBg, rgbm(0.15, 0.15, 0.2, 0.8))
  ui.pushStyleColor(ui.StyleColor.FrameBgHovered, rgbm(0.25, 0.25, 0.35, 1))
  ui.pushStyleColor(ui.StyleColor.FrameBgActive, rgbm(0.2, 0.5, 0.8, 1))
  
  ui.setCursorX(25)
  
  ui.beginGroup()
  if ui.radioButton('##instant', teleportMode == 1) then
    teleportMode = 1
  end
  ui.sameLine(0, 12)
  ui.pushDWriteFont('Arial;Weight=Bold')
  ui.setCursorY(ui.getCursorY() + 2)
  ui.dwriteDrawText('انتقال فوري', 14, vec2(ui.getCursorX(), ui.getCursorY()), rgbm(0.95, 0.95, 0.95, 1))
  ui.popDWriteFont()
  ui.endGroup()
  
  ui.dummy(vec2(0, 12))
  ui.setCursorX(25)
  
  ui.beginGroup()
  if ui.radioButton('##safe', teleportMode == 2) then
    teleportMode = 2
  end
  ui.sameLine(0, 12)
  ui.pushDWriteFont('Arial;Weight=Bold')
  ui.setCursorY(ui.getCursorY() + 2)
  ui.dwriteDrawText('انتقال آمن (نفس السرعة)', 14, vec2(ui.getCursorX(), ui.getCursorY()), rgbm(0.95, 0.95, 0.95, 1))
  ui.popDWriteFont()
  ui.endGroup()
  
  ui.popStyleColor(4)
  
  ui.offsetCursorY(25)
  ui.separator()
  ui.offsetCursorY(20)
  
  ui.pushDWriteFont('Arial;Style=Italic')
  ui.dwriteDrawText('نصيحة: اختر لاعب أولاً، ثم اضغط على OK', 13, vec2(35, ui.getCursorY()), rgbm(1, 0.9, 0.3, 1))
  ui.popDWriteFont()
  
  ui.offsetCursorY(15)
  ui.popItemWidth()
end

-- Event للتحكم في التصادمات مع اللاعبين الآخرين
local disabledCollisionEvent = ac.OnlineEvent({
    ac.StructItem.key('disabledCollisionEvent'),
    disabled = ac.StructItem.boolean()
  },
  function(sender, data)
    if sender == nil then return end
    if sender.index == 0 then return end
    ac.log(string.format('%s collision: [%d] %s', (data.disabled and 'Disabled' or 'Enabled'), sender.index, ac.getDriverName(sender.index)))
    physics.disableCarCollisions(sender.index, data.disabled)
    physics.disableCarCollisions(0, data.disabled)
  end)

local function TeleportHUDClosed(okClicked)
  if okClicked and selectedCar then
    local dir = selectedCar.look
    local spawnPos = selectedCar.position + vec3(0, 0.1, 0) - dir * 8
    
    if teleportMode == 1 then
      physics.setCarVelocity(0, vec3(0, 0, 0))
      physics.setCarPosition(0, spawnPos, -dir)
    else
      local targetVelocity = selectedCar.velocity
      physics.setCarPosition(0, spawnPos, -dir)
      physics.setCarVelocity(0, targetVelocity)
    end
    
    -- تعطيل التصادم باستخدام الأوامر من FastTravel
    ac.log('Disabled own collisions')
    physics.disableCarCollisions(0, true)
    disabledCollisionEvent({ disabled = true })
    disabledCollision = true
    isCollisionDisabled = true
    collisionDisabledTime = os.clock()
    teleportTimer = 0
    ac.log("[TeleportToPlayer] Collisions disabled for 10 seconds")

    selectedCar = nil
    selectedCarIndex = nil
  end
end

function script.update(dt)
  if disabledCollision then
    teleportTimer = teleportTimer + dt

    if teleportTimer >= collisionDuration then
      local tooClose = false
      local playerCar = ac.getCar(0)

      for i = 1, sim.carsCount - 1 do
        local otherCar = ac.getCar(i)
        if otherCar.isConnected then
          local distance = playerCar.position:distance(otherCar.position)
          if distance < 10 then
            tooClose = true
            teleportTimer = teleportTimer - 1
            break
          end
        end
      end

      if not tooClose then
        -- إعادة تفعيل التصادم باستخدام الأوامر من FastTravel
        ac.log('Enabled own collisions')
        physics.disableCarCollisions(0, false)
        disabledCollisionEvent({ disabled = false })
        disabledCollision = false
        isCollisionDisabled = false
        ac.log("[TeleportToPlayer] Collisions re-enabled")
      end
    end
  end
end

ui.registerOnlineExtra(
  ui.Icons.FastForward, 
  'Teleport To Player', 
  nil,
  TeleportHUD, 
  TeleportHUDClosed,
  ui.OnlineExtraFlags.None
)
