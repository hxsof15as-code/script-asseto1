local WINDOW_TITLE = 'Change Car & Skin';
local WINDOW_ICON = ui.Icons.Car;

_local = {
    car = car,
    availableCars = {},
    currentCar = ac.getCarID(0),
    currentSkin = ac.getCarSkinID(0),
    selectedCarSkins = {},
    selectedCar = nil,
    showSkinSelection = false
}

-- Read all available cars from entry list
local function loadAvailableCars()
    _local.availableCars = {}
    local carsCount = ac.getCarsCount()
    local addedCars = {}
    
    for i = 0, carsCount - 1 do
        local carID = ac.getCarID(i)
        if carID and not addedCars[carID] then
            table.insert(_local.availableCars, carID)
            addedCars[carID] = true
        end
    end
    
    table.sort(_local.availableCars)
end

loadAvailableCars()

-- Load skins for specific car
local function loadCarSkins(carID)
    _local.selectedCarSkins = {}
    local contentCarsFolder = ac.getFolder(ac.FolderID.ContentCars)
    local skinsPath = contentCarsFolder .. '/' .. carID .. '/skins'
    
    if io.dirExists(skinsPath) then
        for _, skinFolder in ipairs(io.scanDir(skinsPath, '*')) do
            local fullPath = skinsPath .. '/' .. skinFolder
            if io.dirExists(fullPath) then
                table.insert(_local.selectedCarSkins, skinFolder)
            end
        end
    end
    
    table.sort(_local.selectedCarSkins)
end

-- Sync car and skin change
local syncCarChange = ac.OnlineEvent(
{ 
    newCar = ac.StructItem.string(100),
    newSkin = ac.StructItem.string(100),
    playerIndex = ac.StructItem.int16(),
},
function (sender, data)
    if sender == nil then return end
    applyCarAndSkinChange(data.newCar, data.newSkin, data.playerIndex)
end)

function applyCarAndSkinChange(newCarID, newSkinID, carIndex)
    local targetCar = ac.getCar(carIndex)
    if targetCar == nil then return end
    
    local contentCarsFolder = ac.getFolder(ac.FolderID.ContentCars)
    
    -- Save car state
    local carPos = targetCar.position
    local carDir = targetCar.look
    local carVelocity = targetCar.velocity
    
    -- Change car model if different
    if newCarID ~= ac.getCarID(carIndex) then
        physics.setCarModel(carIndex, newCarID)
        physics.setCarPosition(carIndex, carPos, carDir)
        physics.setCarVelocity(carIndex, carVelocity)
    end
    
    -- Apply skin
    local carNode = ac.findNodes('carRoot:'..carIndex)
    if carNode then
        carNode:resetSkin()
        
        local skinPath = contentCarsFolder .. '/' .. newCarID .. '/skins/' .. newSkinID
        if io.dirExists(skinPath) then
            local skinFiles = io.scanDir(skinPath, '*')
            if skinFiles and #skinFiles > 0 then
                local theSkin = {}
                for _, file in ipairs(skinFiles) do
                    theSkin[file] = skinPath .. '/' .. file
                end
                carNode:applySkin(theSkin)
            end
        end
    end
    
    ac.debug('Car changed to: ' .. newCarID .. ' with skin: ' .. newSkinID)
end

local function windowUI()
    -- Header
    ui.text('Current Car: ' .. _local.currentCar)
    ui.sameLine()
    ui.offsetCursorX(10)
    ui.text('| Skin: ' .. _local.currentSkin)
    ui.separator()
    
    if not _local.showSkinSelection then
        -- Car selection list
        ui.text('Select a car:')
        ui.separator()
        
        ui.childWindow('carsList', vec2(ui.availableSpaceX(), ui.availableSpaceY() - 60), function()
            if #_local.availableCars == 0 then
                ui.text('No cars found. Loading...')
                loadAvailableCars()
            else
                for _, carID in ipairs(_local.availableCars) do
                    local isSelected = (carID == _local.currentCar)
                    
                    if isSelected then
                        ui.pushStyleColor(ui.StyleColor.Header, rgbm(0.2, 0.6, 0.2, 1))
                    end
                    
                    if ui.selectable(carID, isSelected) then
                        _local.selectedCar = carID
                        loadCarSkins(carID)
                        _local.showSkinSelection = true
                    end
                    
                    if isSelected then
                        ui.popStyleColor()
                    end
                    
                    -- Show preview on hover
                    if ui.itemHovered() then
                        ui.tooltip(function()
                            local contentCarsFolder = ac.getFolder(ac.FolderID.ContentCars)
                            local previewPath = contentCarsFolder .. '/' .. carID .. '/ui/badge.png'
                            if io.fileExists(previewPath) then
                                ui.image(previewPath, vec2(128, 128))
                            else
                                ui.text('No preview available')
                            end
                            ui.text('Car ID: ' .. carID)
                        end)
                    end
                end
            end
        end)
        
        ui.separator()
        ui.textWrapped('Click on a car to select it, then choose a skin')
        
    else
        -- Skin selection list
        ui.text('Select skin for: ' .. _local.selectedCar)
        
        if ui.button('< Back to Cars', vec2(150, 30)) then
            _local.showSkinSelection = false
        end
        
        ui.separator()
        
        ui.childWindow('skinsList', vec2(ui.availableSpaceX(), ui.availableSpaceY() - 60), function()
            if #_local.selectedCarSkins == 0 then
                ui.text('No skins found for this car')
            else
                for _, skinID in ipairs(_local.selectedCarSkins) do
                    if ui.selectable(skinID, false) then
                        -- Apply changes
                        applyCarAndSkinChange(_local.selectedCar, skinID, _local.car.index)
                        
                        -- Sync with other players
                        syncCarChange({
                            newCar = _local.selectedCar,
                            newSkin = skinID,
                            playerIndex = _local.car.index
                        }, true)
                        
                        _local.currentCar = _local.selectedCar
                        _local.currentSkin = skinID
                        _local.showSkinSelection = false
                    end
                    
                    -- Show preview on hover
                    if ui.itemHovered() then
                        ui.tooltip(function()
                            local contentCarsFolder = ac.getFolder(ac.FolderID.ContentCars)
                            local previewPath = contentCarsFolder .. '/' .. _local.selectedCar .. '/skins/' .. skinID .. '/preview.jpg'
                            if io.fileExists(previewPath) then
                                ui.image(previewPath, vec2(256, 144))
                            else
                                ui.text('No preview available')
                            end
                            ui.text('Skin: ' .. skinID)
                        end)
                    end
                end
            end
        end)
        
        ui.separator()
        ui.textWrapped('Click on a skin to apply it')
    end
end

local function onWindowUIClose(okClicked)
    _local.showSkinSelection = false
end

ui.registerOnlineExtra(WINDOW_ICON, WINDOW_TITLE, nil, windowUI, onWindowUIClose, nil, nil, vec2(450, 600));
