local WINDOW_TITLE = 'Change Car & Skin';
local WINDOW_ICON = ui.Icons.Car;

_local = {
    car = car,
    availableCars = {},
    currentCar = ac.getCarID(0),
    currentSkin = ac.getCarSkinID(0),
    selectedCarSkins = {},
    selectedCar = nil,
    showSkinSelection = false
}

-- Ù‚Ø±Ø§Ø¡Ø© Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø³ÙŠØ§Ø±Ø§Øª Ø§Ù„Ù…ØªÙˆÙØ±Ø©
local contentCarsFolder = ac.getFolder(ac.FolderID.ContentCars)
for _, carFolder in ipairs(io.scanDir(contentCarsFolder, '*')) do
    if io.dirExists(contentCarsFolder .. '/' .. carFolder) then
        table.insert(_local.availableCars, carFolder)
    end
end

-- Ù‚Ø±Ø§Ø¡Ø© Ø³ÙƒÙ†Ø§Øª Ø³ÙŠØ§Ø±Ø© Ù…Ø¹ÙŠÙ†Ø©
local function loadCarSkins(carID)
    _local.selectedCarSkins = {}
    local skinsPath = contentCarsFolder .. '/' .. carID .. '/skins'
    if io.dirExists(skinsPath) then
        for _, skinFolder in ipairs(io.scanDir(skinsPath, '*')) do
            if io.dirExists(skinsPath .. '/' .. skinFolder) then
                table.insert(_local.selectedCarSkins, skinFolder)
            end
        end
    end
end

-- Ù…Ø²Ø§Ù…Ù†Ø© ØªØºÙŠÙŠØ± Ø§Ù„Ø³ÙŠØ§Ø±Ø© ÙˆØ§Ù„Ø³ÙƒÙ†
local syncCarChange = ac.OnlineEvent(
{ 
    newCar = ac.StructItem.string(100),
    newSkin = ac.StructItem.string(100),
    playerIndex = ac.StructItem.int16(),
},
function (sender, data)
    if sender == nil then return end
    applyCarAndSkinChange(data.newCar, data.newSkin, data.playerIndex)
end)

function applyCarAndSkinChange(newCarID, newSkinID, carIndex)
    local targetCar = ac.getCar(carIndex)
    if targetCar == nil then return end
    
    -- Ø­ÙØ¸ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø³ÙŠØ§Ø±Ø©
    local carPos = targetCar.position
    local carDir = targetCar.look
    local carVelocity = targetCar.velocity
    
    -- ØªØºÙŠÙŠØ± Ø§Ù„Ø³ÙŠØ§Ø±Ø© ÙˆØ§Ù„Ø³ÙƒÙ†
    if newCarID ~= ac.getCarID(carIndex) then
        physics.setCarModel(carIndex, newCarID)
        physics.setCarPosition(carIndex, carPos, carDir)
        physics.setCarVelocity(carIndex, carVelocity)
    end
    
    -- ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø³ÙƒÙ†
    local carNode = ac.findNodes('carRoot:'..carIndex)
    carNode:resetSkin()
    
    local skinPath = contentCarsFolder .. '/' .. newCarID .. '/skins/' .. newSkinID
    if io.dirExists(skinPath) then
        local skinFiles = io.scanDir(skinPath, '*')
        local theSkin = {}
        for _, file in ipairs(skinFiles) do
            theSkin[file] = skinPath .. '/' .. file
        end
        carNode:applySkin(theSkin)
    end
    
    ac.debug('Car changed to: ' .. newCarID .. ' with skin: ' .. newSkinID)
end

local function windowUI()
    ui.text('Ø§Ù„Ø³ÙŠØ§Ø±Ø©: ' .. _local.currentCar)
    ui.sameLine()
    ui.text('| Ø§Ù„Ø³ÙƒÙ†: ' .. _local.currentSkin)
    ui.separator()
    
    if not _local.showSkinSelection then
        -- Ø¹Ø±Ø¶ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø³ÙŠØ§Ø±Ø§Øª
        ui.text('Ø§Ø®ØªØ± Ø³ÙŠØ§Ø±Ø©:')
        ui.childWindow('carsList', vec2(ui.availableSpaceX(), ui.availableSpaceY() - 50), function()
            for _, carID in ipairs(_local.availableCars) do
                local isSelected = (carID == _local.currentCar)
                
                if isSelected then
                    ui.pushStyleColor(ui.StyleColor.Header, rgbm(0.2, 0.6, 0.2, 1))
                end
                
                if ui.selectable(carID, isSelected) then
                    _local.selectedCar = carID
                    loadCarSkins(carID)
                    _local.showSkinSelection = true
                end
                
                if isSelected then
                    ui.popStyleColor()
                end
                
                if ui.itemHovered() then
                    ui.tooltip(function()
                        local previewPath = contentCarsFolder .. '/' .. carID .. '/ui/badge.png'
                        if io.fileExists(previewPath) then
                            ui.image(previewPath, vec2(128, 128))
                        end
                    end)
                end
            end
        end)
        
        ui.separator()
        ui.text('ğŸ’¡ Ø§Ø®ØªØ± Ø§Ù„Ø³ÙŠØ§Ø±Ø© Ø«Ù… Ø§Ø®ØªØ± Ø§Ù„Ø³ÙƒÙ†')
        
    else
        -- Ø¹Ø±Ø¶ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø³ÙƒÙ†Ø§Øª Ù„Ù„Ø³ÙŠØ§Ø±Ø© Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©
        ui.text('Ø§Ø®ØªØ± Ø³ÙƒÙ† Ù„Ù€: ' .. _local.selectedCar)
        
        if ui.button('< Ø±Ø¬ÙˆØ¹ Ù„Ù„Ø³ÙŠØ§Ø±Ø§Øª', vec2(150, 30)) then
            _local.showSkinSelection = false
        end
        
        ui.childWindow('skinsList', vec2(ui.availableSpaceX(), ui.availableSpaceY() - 50), function()
            for _, skinID in ipairs(_local.selectedCarSkins) do
                if ui.selectable(skinID, false) then
                    -- ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ØªØºÙŠÙŠØ±
                    applyCarAndSkinChange(_local.selectedCar, skinID, _local.car.index)
                    
                    -- Ù…Ø²Ø§Ù…Ù†Ø© Ù…Ø¹ Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ†
                    syncCarChange({
                        newCar = _local.selectedCar,
                        newSkin = skinID,
                        playerIndex = _local.car.index
                    }, true)
                    
                    _local.currentCar = _local.selectedCar
                    _local.currentSkin = skinID
                    _local.showSkinSelection = false
                end
                
                if ui.itemHovered() then
                    ui.tooltip(function()
                        local previewPath = contentCarsFolder .. '/' .. _local.selectedCar .. '/skins/' .. skinID .. '/preview.jpg'
                        if io.fileExists(previewPath) then
                            ui.image(previewPath, vec2(256, 144))
                        else
                            ui.text('Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø¹Ø§ÙŠÙ†Ø©')
                        end
                    end)
                end
            end
        end)
        
        ui.separator()
        ui.text('ğŸ’¡ Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„Ø³ÙƒÙ† Ù„Ù„ØªØ·Ø¨ÙŠÙ‚')
    end
end

local function onWindowUIClose(okClicked)
    _local.showSkinSelection = false
end

ui.registerOnlineExtra(WINDOW_ICON, WINDOW_TITLE, nil, windowUI, onWindowUIClose, nil, nil, vec2(450, 550));
