local WINDOW_TITLE = 'Change Car & Skin';
local WINDOW_ICON = ui.Icons.Car;

_local = {
    car = car,
    availableCars = {},
    currentCarID = ac.getCarID(0),
    currentSkin = ac.getCarSkinID(0),
    selectedCarSkins = {},
    selectedCarID = nil,
    showSkinSelection = false
}

local contentCarsFolder = ac.getFolder(ac.FolderID.ContentCars)

-- Debug: print the path
ac.debug('Content cars folder: ' .. contentCarsFolder)

-- Read all available cars
local carFolders = io.scanDir(contentCarsFolder, '*')
ac.debug('Found folders: ' .. #carFolders)

for i = 1, #carFolders do
    local carFolder = carFolders[i]
    local carPath = contentCarsFolder .. '/' .. carFolder
    -- Check if it's a valid car folder (has data folder)
    if io.dirExists(carPath .. '/data') then
        table.insert(_local.availableCars, carFolder)
        ac.debug('Added car: ' .. carFolder)
    end
end

ac.debug('Total cars loaded: ' .. #_local.availableCars)
table.sort(_local.availableCars)

-- Read skins for specific car
local function loadCarSkins(carID)
    _local.selectedCarSkins = {}
    local skinsPath = contentCarsFolder .. '/' .. carID .. '/skins'
    
    if io.dirExists(skinsPath) then
        local skinFolders = io.scanDir(skinsPath, '*')
        for i = 1, #skinFolders do
            local skinFolder = skinFolders[i]
            local skinPath = skinsPath .. '/' .. skinFolder
            if io.dirExists(skinPath) then
                table.insert(_local.selectedCarSkins, skinFolder)
            end
        end
    end
    
    table.sort(_local.selectedCarSkins)
end

-- Sync car and skin change
local syncCarChange = ac.OnlineEvent(
{ 
    newCar = ac.StructItem.string(100),
    newSkin = ac.StructItem.string(100),
    playerIndex = ac.StructItem.int16(),
},
function (sender, data)
    if sender == nil then return end
    applyCarAndSkinChange(data.newCar, data.newSkin, data.playerIndex)
end)

-- Get skin files
local function getCarSkinFiles(carID, skinID)
    local files = {}
    local skinPath = contentCarsFolder .. '/' .. carID .. '/skins/' .. skinID
    
    if io.dirExists(skinPath) then
        local skinFiles = io.scanDir(skinPath, '*')
        for i = 1, #skinFiles do
            table.insert(files, skinFiles[i])
        end
    end
    
    return files
end

-- Apply car and skin change
function applyCarAndSkinChange(newCarID, newSkinID, carIndex)
    local targetCar = ac.getCar(carIndex)
    if targetCar == nil then return end
    
    -- Get car node
    local carNode = ac.findNodes('carRoot:'..carIndex)
    if not carNode then
        ac.debug('Car node not found')
        return
    end
    
    -- Save car state
    local carPos = targetCar.position
    local carDir = targetCar.look
    local carVelocity = targetCar.velocity
    
    -- If changing car model, we need to respawn
    if newCarID ~= ac.getCarID(carIndex) then
        -- Note: Changing car model requires game restart or pit respawn
        -- This will only change the skin for now
        ac.debug('Car model change requires respawn. Applying skin only.')
    end
    
    -- Apply skin
    carNode:resetSkin()
    
    local skinPath = contentCarsFolder .. '/' .. newCarID .. '/skins/' .. newSkinID
    if io.dirExists(skinPath) then
        local skinFiles = getCarSkinFiles(newCarID, newSkinID)
        
        if #skinFiles > 0 then
            local theSkin = {}
            for _, file in ipairs(skinFiles) do
                theSkin[file] = skinPath .. '/' .. file
            end
            carNode:applySkin(theSkin)
            ac.debug('Skin applied: ' .. newSkinID)
        end
    end
    
    -- Restore position if needed
    physics.setCarPosition(carIndex, carPos, carDir)
end

-- UI Window
local function windowUI()
    -- Header
    ui.text('Current Car: ')
    ui.sameLine()
    ui.pushStyleColor(ui.StyleColor.Text, rgbm(0.3, 1, 0.3, 1))
    ui.text(_local.currentCarID)
    ui.popStyleColor()
    
    ui.sameLine()
    ui.offsetCursorX(10)
    ui.text('| Skin: ')
    ui.sameLine()
    ui.pushStyleColor(ui.StyleColor.Text, rgbm(0.3, 1, 0.3, 1))
    ui.text(_local.currentSkin)
    ui.popStyleColor()
    
    ui.separator()
    
    if not _local.showSkinSelection then
        -- Car selection list
        ui.text('Select a car:')
        ui.separator()
        
        ui.childWindow('carsList', vec2(ui.availableSpaceX(), ui.availableSpaceY() - 60), function()
            if #_local.availableCars == 0 then
                ui.text('No cars found in content/cars folder')
                ui.text('Path: ' .. contentCarsFolder)
                ui.separator()
                ui.text('Debug Info:')
                ui.text('Check AC console (Home button) for details')
            else
                for _, carID in ipairs(_local.availableCars) do
                    local isSelected = (carID == _local.currentCarID)
                    
                    if isSelected then
                        ui.pushStyleColor(ui.StyleColor.Header, rgbm(0.2, 0.6, 0.2, 1))
                        ui.pushStyleColor(ui.StyleColor.HeaderHovered, rgbm(0.25, 0.7, 0.25, 1))
                        ui.pushStyleColor(ui.StyleColor.HeaderActive, rgbm(0.3, 0.8, 0.3, 1))
                    end
                    
                    if ui.selectable(carID, isSelected) then
                        _local.selectedCarID = carID
                        loadCarSkins(carID)
                        _local.showSkinSelection = true
                    end
                    
                    if isSelected then
                        ui.popStyleColor(3)
                    end
                    
                    -- Show preview on hover
                    if ui.itemHovered() then
                        ui.tooltip(function()
                            local previewPath = contentCarsFolder .. '/' .. carID .. '/ui/badge.png'
                            if io.fileExists(previewPath) then
                                ui.image(previewPath, vec2(128, 128))
                            else
                                ui.text('No preview available')
                            end
                            ui.separator()
                            ui.text('Car: ' .. carID)
                            
                            -- Check for KN5 file
                            local kn5Path = contentCarsFolder .. '/' .. carID .. '/' .. carID .. '.kn5'
                            if io.fileExists(kn5Path) then
                                ui.text('Model: ' .. carID .. '.kn5')
                            end
                        end)
                    end
                end
            end
        end)
        
        ui.separator()
        ui.text('ðŸ’¡ Click on a car to view its skins')
        
    else
        -- Skin selection list
        ui.text('Select skin for: ')
        ui.sameLine()
        ui.pushStyleColor(ui.StyleColor.Text, rgbm(1, 0.8, 0.3, 1))
        ui.text(_local.selectedCarID)
        ui.popStyleColor()
        
        if ui.button('< Back to Cars', vec2(150, 30)) then
            _local.showSkinSelection = false
        end
        
        ui.separator()
        
        ui.childWindow('skinsList', vec2(ui.availableSpaceX(), ui.availableSpaceY() - 60), function()
            if #_local.selectedCarSkins == 0 then
                ui.text('No skins found for this car')
            else
                for _, skinID in ipairs(_local.selectedCarSkins) do
                    local isSelected = (_local.selectedCarID == _local.currentCarID and skinID == _local.currentSkin)
                    
                    if isSelected then
                        ui.pushStyleColor(ui.StyleColor.Header, rgbm(0.2, 0.6, 0.2, 1))
                        ui.pushStyleColor(ui.StyleColor.HeaderHovered, rgbm(0.25, 0.7, 0.25, 1))
                        ui.pushStyleColor(ui.StyleColor.HeaderActive, rgbm(0.3, 0.8, 0.3, 1))
                    end
                    
                    if ui.selectable(skinID, isSelected) then
                        -- Apply changes
                        applyCarAndSkinChange(_local.selectedCarID, skinID, _local.car.index)
                        
                        -- Sync with other players
                        syncCarChange({
                            newCar = _local.selectedCarID,
                            newSkin = skinID,
                            playerIndex = _local.car.index
                        }, true)
                        
                        _local.currentCarID = _local.selectedCarID
                        _local.currentSkin = skinID
                        _local.showSkinSelection = false
                    end
                    
                    if isSelected then
                        ui.popStyleColor(3)
                    end
                    
                    -- Show preview on hover
                    if ui.itemHovered() then
                        ui.tooltip(function()
                            local previewPath = contentCarsFolder .. '/' .. _local.selectedCarID .. '/skins/' .. skinID .. '/preview.jpg'
                            if io.fileExists(previewPath) then
                                ui.image(previewPath, vec2(256, 144))
                            else
                                ui.text('No preview available')
                            end
                            ui.separator()
                            ui.text('Skin: ' .. skinID)
                            
                            -- Count skin files
                            local files = getCarSkinFiles(_local.selectedCarID, skinID)
                            ui.text('Files: ' .. #files)
                        end)
                    end
                end
            end
        end)
        
        ui.separator()
        ui.text('ðŸ’¡ Click on a skin to apply it')
    end
end

local function onWindowUIClose(okClicked)
    _local.showSkinSelection = false
end

ui.registerOnlineExtra(WINDOW_ICON, WINDOW_TITLE, nil, windowUI, onWindowUIClose, nil, nil, vec2(450, 600));
